# fly.toml — moodboard full deployment

app = "moodboard"
primary_region = "iad"

[build]
  dockerfile = "Dockerfile"

[env]
  REDIS_URL = "redis://moodboard-redis.internal:6379"
  APP_ENV = "production"

# ------------------------------------------------------------------
# Process definitions
# ------------------------------------------------------------------

[processes]
  app = "uvicorn app.main:app --host 0.0.0.0 --port 8080 --forwarded-allow-ips='*'"
  worker = "arq app.core.arq_worker.WorkerSettings"

# ------------------------------------------------------------------
# Restart policy — ensures worker and API recover from failures
# ------------------------------------------------------------------
[[restart]]
  policy = "always"
  processes = ["worker"]

[[restart]]
  policy = "always"
  processes = ["app"]

# ------------------------------------------------------------------
# Services — for the web API
# ------------------------------------------------------------------
[[services]]
  internal_port = 8080
  processes = ["app"]
  protocol = "tcp"
  auto_start_machines = true
  auto_stop_machines = false

  [services.concurrency]
    type = "connections"
    soft_limit = 40
    hard_limit = 50

  [[services.ports]]
    handlers = ["tls", "http"]
    port = 443

  [[services.ports]]
    handlers = ["http"]
    port = 80

# ------------------------------------------------------------------
# Virtual machine resources
# ------------------------------------------------------------------
# Web app: lighter, faster response focus
[[vm]]
  processes = ["app"]
  size = "shared-cpu-1x"
  cpus = 1
  memory = "1gb"
  cpu_kind = "shared"

# Worker: heavier compute for OpenAI, clustering, etc.
[[vm]]
  processes = ["worker"]
  size = "shared-cpu-2x"
  cpus = 2
  memory = "2gb"
  cpu_kind = "shared"