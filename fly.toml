# fly.toml — moodboard full deployment

app = "moodboard"
primary_region = "iad"

[build]
  dockerfile = "Dockerfile"

[env]
  REDIS_URL = "redis://moodboard-redis.internal:6379/0"
  APP_ENV = "production"
  FLY_API_TOKEN = "FlyV1 fm2_lJPECAAAAAAACs0ixBCOLRX8+gqLwxGwck4QfyYlwrVodHRwczovL2FwaS5mbHkuaW8vdjGWAJLOABRQIx8Lk7lodHRwczovL2FwaS5mbHkuaW8vYWFhL3YxxDygyr3vWzo2p3Z3AhmfE22Nu9UeHIqPsTefUNqcQvKDBAz7nlz7lzoFFR2EtRm8ohEb3xRsSzRsWmUJClLETtmN0HTGExPmF7I/wznXrmDWmEtw2rGQKgtBHQkaETQ10TTuFxD5qLTdEGi01VxxAGetbo0YNPSFUSID/MwKsQAAFSKJ7qVQFnF7B7M3zQ2SlAORgc4Aq9ywHwWRgqdidWlsZGVyH6J3Zx8BxCABgxRDTqi7pVc0SAyRo7VUweUyL9gVLvK0JFKh5PZlBg==,fm2_lJPETtmN0HTGExPmF7I/wznXrmDWmEtw2rGQKgtBHQkaETQ10TTuFxD5qLTdEGi01VxxAGetbo0YNPSFUSID/MwKsQAAFSKJ7qVQFnF7B7M3zcQQCvmk6F9Mr5uIGuOACIIR+8O5aHR0cHM6Ly9hcGkuZmx5LmlvL2FhYS92MZgEks5pDToQzo6lQC4XzgATgvkKkc4AE4L5DMQQncb0foHs7SQK7U57iKqlksQgNJHtq8QWxMpb4gmWlmt+l46c1j4jWnlM+BsKvm4C15Y="

# ------------------------------------------------------------------
# Process definitions
# ------------------------------------------------------------------

[processes]
  app = "uvicorn app.main:app --host 0.0.0.0 --port 8080 --forwarded-allow-ips='*'"
  worker = "python -m app.core.arq_worker"

# ------------------------------------------------------------------
# Restart policy — ensures worker and API recover from failures
# ------------------------------------------------------------------
[[restart]]
  policy = "always"
  processes = ["worker"]

[[restart]]
  policy = "always"
  processes = ["app"]

# ------------------------------------------------------------------
# Services — for the web API
# ------------------------------------------------------------------
[[services]]
  internal_port = 8080
  processes = ["app"]
  protocol = "tcp"
  auto_start_machines = true
  auto_stop_machines = false

  [services.concurrency]
    type = "connections"
    soft_limit = 40
    hard_limit = 50

  [[services.ports]]
    handlers = ["tls", "http"]
    port = 443

  [[services.ports]]
    handlers = ["http"]
    port = 80

# ------------------------------------------------------------------
# Virtual machine resources
# ------------------------------------------------------------------
# Web app: lighter, faster response focus
[[vm]]
  processes = ["app"]
  size = "shared-cpu-1x"
  cpus = 1
  memory = "1gb"
  cpu_kind = "shared"

# Worker: heavier compute for OpenAI, clustering, etc.
[[vm]]
  processes = ["worker"]
  size = "shared-cpu-2x"
  cpus = 2
  memory = "2gb"
  cpu_kind = "shared"